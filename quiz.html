<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brewlio – Coffee Taste Quiz</title>

  <meta name="description" content="Brewlio matches you to beans based on your grinder, machine, and taste. No jargon. No signup. About a minute." />
  <link rel="stylesheet" href="style.css" />

  <!-- Inline SVG favicon (fine; browser may still try /favicon.ico which can 404 harmlessly) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☕</text></svg>">

  <!-- Supabase client (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- Top bar -->
  <header class="t-bar">
    <nav class="nav-left" aria-label="Primary">
      <a href="index.html#about">How it works</a>
      <a href="index.html#shop">Roasts</a>
      <a href="index.html#why">Why local</a>
      <a href="index.html#partner">Roasters</a>
    </nav>
    <a href="index.html" class="logo logo-link" aria-label="Brewlio home">
      <span class="logo-main">BREWLIO</span>
      <span class="logo-sub">coffee that just makes sense</span>
    </a>
  </header>

  <!-- Greeting -->
  <div id="greeting" class="greeting" aria-live="polite">
    <strong>One minute to better coffee.</strong>
    <span class="tip">Pick what sounds like you. No jargon.</span>
  </div>

  <!-- Quiz Section -->
  <section class="quiz-section">
    <div class="quiz-container">

      <div class="quiz-header">
        <h1>Coffee Taste Quiz</h1>
        <p class="quiz-lede">
          We'll match you with beans based on your taste + how you drink coffee.
          <span class="quiz-lede-sub">Free. No account. Retake anytime.</span>
        </p>

        <div class="quiz-meta" aria-label="Progress">
          <span id="stepText" class="step-text">Question 1 of 7</span>
          <span id="stepHint" class="step-hint">Pick one to continue</span>
        </div>
      </div>

      <form id="coffeeQuiz" novalidate>
        <!-- Q1: Brew method -->
        <fieldset class="question active" data-q="brew">
          <legend>How do you usually make coffee?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNWp4cXN4MHcyNXFobXJycW14dmhsYWJmaHp1NHN1c2N0NTdkcHp5OCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/mQCc4gIeZf746w1hSZ/giphy.gif" type="image/gif">
              <img src="Assets/espresso_fallback.jpg" alt="Espresso shot pulling" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Brew method">
            <div class="option">
              <input type="radio" id="brew-espresso" name="brew" value="espresso" required>
              <label for="brew-espresso">Espresso machine</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-pourover" name="brew" value="pour-over">
              <label for="brew-pourover">Pour-over / filter</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-plunger" name="brew" value="french-press">
              <label for="brew-plunger">French press / plunger</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-moka" name="brew" value="stovetop">
              <label for="brew-moka">Stovetop (moka pot)</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-other" name="brew" value="other">
              <label for="brew-other">Other / instant (no judgement)</label>
            </div>
          </div>
        </fieldset>

        <!-- Q2: Grinder -->
        <fieldset class="question" data-q="grinder">
          <legend>What grinder situation are you working with?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media.giphy.com/media/3o7TKsQ8l5dQ0JdEw8/giphy.gif" type="image/gif">
              <img src="Assets/roast_fallback.jpg" alt="Grinding coffee" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Grinder tier">
            <div class="option">
              <input type="radio" id="gr-pre" name="grinder" value="pre-ground" required>
              <label for="gr-pre">Pre-ground (or I don’t grind at home)</label>
            </div>
            <div class="option">
              <input type="radio" id="gr-blade" name="grinder" value="blade">
              <label for="gr-blade">Blade grinder (the chaos option)</label>
            </div>
            <div class="option">
              <input type="radio" id="gr-burr-basic" name="grinder" value="burr-basic">
              <label for="gr-burr-basic">Entry burr (Smart Grinder Pro, Encore ESP, etc.)</label>
            </div>
            <div class="option">
              <input type="radio" id="gr-burr-good" name="grinder" value="burr-good">
              <label for="gr-burr-good">Good burr (Niche / DF64 / Eureka, etc.)</label>
            </div>
            <div class="option">
              <input type="radio" id="gr-cafe" name="grinder" value="cafe">
              <label for="gr-cafe">Café-tier / “I have opinions” (Mazzer / EK-style)</label>
            </div>
          </div>
        </fieldset>

        <!-- Q3: Espresso machine (conditional) -->
        <fieldset class="question" data-q="machine" data-conditional="espresso">
          <legend>If you make espresso, what machine is closest to yours?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" type="image/gif">
              <img src="Assets/espresso_fallback.jpg" alt="Espresso machine" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Espresso machine tier">
            <div class="option">
              <input type="radio" id="mach-entry" name="machine" value="entry">
              <label for="mach-entry">Beginner / entry (Bambino, Dedica, basic single boiler)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-capable" name="machine" value="capable">
              <label for="mach-capable">Capable home (Gaggia Classic, Silvia, Barista Express/Pro)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-advanced" name="machine" value="advanced">
              <label for="mach-advanced">Advanced / prosumer (Dual boiler or HX, incl. Breville Dual Boiler)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-elite" name="machine" value="elite">
              <label for="mach-elite">Elite / café-tier (La Marzocco Linea, E61 w/ flow control, etc.)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-notsure" name="machine" value="not-sure">
              <label for="mach-notsure">Not sure (fair)</label>
            </div>
          </div>
        </fieldset>

        <!-- Q4: Milk -->
        <fieldset class="question" data-q="milk">
          <legend>Do you drink it with milk?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExejF3a2ticTA2N2ZvOTBrd2ZqZTNxd2NrbnFheHE0M3NkeTVwbmk0YyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/h55EUEsTG9224/giphy.gif" type="image/gif">
              <img src="Assets/milk_fallback.jpg" alt="Pouring milk into coffee" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Milk preference">
            <div class="option">
              <input type="radio" id="milk-black" name="milk" value="black" required>
              <label for="milk-black">Always black</label>
            </div>
            <div class="option">
              <input type="radio" id="milk-sometimes" name="milk" value="sometimes">
              <label for="milk-sometimes">Sometimes</label>
            </div>
            <div class="option">
              <input type="radio" id="milk-always" name="milk" value="always">
              <label for="milk-always">Always with milk</label>
            </div>
          </div>
        </fieldset>

        <!-- Q5: Flavour -->
        <fieldset class="question" data-q="flavour">
          <legend>What flavours do you enjoy?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNnVtMm80OXQ4MXh2endvMnp4OHd5ZWZ1YzdjN3MzYWhwaGx1NW8zMSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Q6joirtIBHUsw/giphy.gif" type="image/gif">
              <img src="Assets/fruity_fallback.jpg" alt="Coffee pour" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Flavour preference">
            <div class="option">
              <input type="radio" id="flavour-fruity" name="flavour" value="fruity" required>
              <label for="flavour-fruity">Bright, fruity, juicy</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-choc" name="flavour" value="chocolate">
              <label for="flavour-choc">Chocolate, nutty, caramel</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-balanced" name="flavour" value="balanced">
              <label for="flavour-balanced">Balanced — a bit of both</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-bold" name="flavour" value="bold">
              <label for="flavour-bold">Bold, dark, intense</label>
            </div>
          </div>
        </fieldset>

        <!-- Q6: Roast -->
        <fieldset class="question" data-q="roast">
          <legend>How dark do you like your roast?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExYzRyYXk2NHJreHRxdDRraThzeGg3bnY4bmczbXBuNnIxdjdkNjh6dSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/lg6LhRzBjPO6xIaHen/giphy.gif" type="image/gif">
              <img src="Assets/roast_fallback.jpg" alt="Coffee beans roasting" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Roast preference">
            <div class="option">
              <input type="radio" id="roast-light" name="roast" value="light" required>
              <label for="roast-light">Light — I want origin character</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-medium" name="roast" value="medium">
              <label for="roast-medium">Medium — classic & smooth</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-dark" name="roast" value="dark">
              <label for="roast-dark">Dark — big & bold</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-any" name="roast" value="any">
              <label for="roast-any">Not sure / surprise me</label>
            </div>
          </div>
        </fieldset>

        <!-- Q7: Workflow -->
        <fieldset class="question" data-q="workflow">
          <legend>How hands-on are you when it comes to dialing in?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media.giphy.com/media/26BRv0ThflsHCqDrG/giphy.gif" type="image/gif">
              <img src="Assets/latteart_fallback.jpg" alt="Coffee workflow" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Workflow confidence">
            <div class="option">
              <input type="radio" id="wf-set" name="workflow" value="set-and-forget" required>
              <label for="wf-set">Set-and-forget. I want it easy.</label>
            </div>
            <div class="option">
              <input type="radio" id="wf-some" name="workflow" value="some">
              <label for="wf-some">I’ll tweak a little if it’s off.</label>
            </div>
            <div class="option">
              <input type="radio" id="wf-regular" name="workflow" value="regular">
              <label for="wf-regular">I dial in properly. I like repeatable results.</label>
            </div>
            <div class="option">
              <input type="radio" id="wf-nerd" name="workflow" value="nerd">
              <label for="wf-nerd">Nerd mode. I own scales… and opinions.</label>
            </div>
          </div>
        </fieldset>

        <!-- Controls -->
        <div class="quiz-controls">
          <button type="button" id="prevBtn" class="quiz-btn secondary" disabled>Previous</button>
          <button type="button" id="nextBtn" class="quiz-btn primary">Next</button>
          <button type="submit" id="submitBtn" class="quiz-btn primary hidden" disabled>Show my match →</button>
        </div>

        <div class="progress-bar" aria-hidden="true">
          <div class="progress"></div>
        </div>

        <p id="errorText" class="quiz-error" role="status" aria-live="polite"></p>
      </form>

      <!-- Results -->
      <div id="results" class="results hidden">
        <h2>Your coffee match</h2>
        <p class="results-lede">Here's what fits your taste — and why.</p>
        <div id="recommendation"></div>

        <div class="results-actions">
          <a href="index.html" class="btn-primary">Back to home</a>
          <button type="button" id="retakeBtn" class="btn-secondary">Retake quiz</button>
        </div>
      </div>

    </div>
  </section>

  <script>
    // Greeting (updated: no third-party IP lookup; avoids CORS/429 + privacy concerns)
    (() => {
      const el = document.getElementById('greeting');
      el.innerHTML = `<strong>Almost there. Pick what sounds like you.</strong><span class="tip">No jargon. No account. Just taste.</span>`;
    })();

    // Supabase setup
    // - SUPABASE_URL: Project Settings → API → Data API → Project URL
    // - SUPABASE_ANON_KEY: Project Settings → API → API Keys → Publishable key
    const SUPABASE_URL = "https://opledkjivawysybvbqxe.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_FxH-YkKnC8mZD8R0hSgXEg_mgrR20K_";

    let sb = null;
    try {
      const looksValid =
        typeof SUPABASE_URL === "string" &&
        SUPABASE_URL.startsWith("http") &&
        SUPABASE_URL.includes("supabase.co") &&
        typeof SUPABASE_ANON_KEY === "string" &&
        SUPABASE_ANON_KEY.length > 10; // relaxed: publishable keys can be short

      if (looksValid && window.supabase?.createClient) {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client ready:", !!sb);
      } else {
        console.warn("Supabase not initialized: invalid/missing URL or key");
      }
    } catch (err) {
      console.warn("Supabase init failed (quiz still works):", err);
    }

    const sessionId = (() => {
      const key = "brewlio_sid";
      let id = localStorage.getItem(key);
      if (!id) {
        id = crypto.randomUUID?.() || Date.now().toString(36) + Math.random().toString(36).slice(2);
        localStorage.setItem(key, id);
      }
      return id;
    })();

    // Quiz logic with conditional questions
    const form = document.getElementById('coffeeQuiz');
    const allQuestions = Array.from(document.querySelectorAll('.question'));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progress = document.querySelector('.progress');
    const results = document.getElementById('results');
    const recommendation = document.getElementById('recommendation');
    const stepText = document.getElementById('stepText');
    const stepHint = document.getElementById('stepHint');
    const errorText = document.getElementById('errorText');
    const retakeBtn = document.getElementById('retakeBtn');

    let currentIndex = 0;
    let activeQuestions = [];

    function getAnswer(name) {
      const el = form.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : null;
    }

    function rebuildActiveQuestions() {
      const brew = getAnswer('brew');
      activeQuestions = allQuestions.filter(q => {
        const cond = q.getAttribute('data-conditional');
        if (!cond) return true;
        return cond === brew;
      });

      const machineFieldset = allQuestions.find(q => q.getAttribute('data-q') === 'machine');
      if (machineFieldset) {
        const inputs = machineFieldset.querySelectorAll('input[type="radio"]');
        const isActive = activeQuestions.includes(machineFieldset);
        inputs.forEach(i => i.required = isActive);
        if (!isActive) inputs.forEach(i => i.checked = false);
      }

      currentIndex = Math.min(currentIndex, activeQuestions.length - 1);
    }

    function total() { return activeQuestions.length; }

    function isAnswered(idx) {
      const q = activeQuestions[idx];
      return !!q.querySelector('input[type="radio"]:checked');
    }

    function setButtons() {
      prevBtn.disabled = currentIndex === 0;

      const last = currentIndex === total() - 1;
      const answered = isAnswered(currentIndex);

      nextBtn.classList.toggle('hidden', last);
      submitBtn.classList.toggle('hidden', !last);

      nextBtn.disabled = !answered;
      submitBtn.disabled = !answered;

      stepText.textContent = `Question ${currentIndex + 1} of ${total()}`;
      stepHint.textContent = answered ? 'Nice — continue' : 'Pick one to continue';
    }

    function showQuestion(idx) {
      allQuestions.forEach(q => q.classList.remove('active'));
      activeQuestions[idx].classList.add('active');

      errorText.textContent = '';
      progress.style.width = `${((idx + 1) / total()) * 100}%`;
      setButtons();
      activeQuestions[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    form.addEventListener('change', (e) => {
      if (!e.target.matches('input[type="radio"]')) return;

      if (e.target.name === 'brew') {
        rebuildActiveQuestions();
        showQuestion(currentIndex);
        return;
      }

      setButtons();
    });

    nextBtn.addEventListener('click', () => {
      if (!isAnswered(currentIndex)) {
        errorText.textContent = 'Pick an option to continue.';
        return;
      }
      currentIndex++;
      showQuestion(currentIndex);
    });

    prevBtn.addEventListener('click', () => {
      currentIndex--;
      showQuestion(currentIndex);
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!isAnswered(currentIndex)) {
        errorText.textContent = 'Pick an option to see your match.';
        return;
      }

      const data = new FormData(form);
      const a = Object.fromEntries(data);

      const brew = a.brew || 'other';
      const grinder = a.grinder || 'pre-ground';
      const machine = a.machine || 'not-sure';
      const workflow = a.workflow || 'some';

      let roast = 'medium';
      let style = 'balanced & sweet';
      let notes = [];

      if (a.flavour === 'fruity') style = 'bright & fruity — think Ethiopian / Kenyan';
      if (a.flavour === 'chocolate') style = 'chocolatey & nutty — think Colombian / Brazilian';
      if (a.flavour === 'balanced') style = 'balanced & sweet — classic crowd-pleaser';
      if (a.flavour === 'bold') style = 'bold & intense — think robust blend / Indonesian';

      if (a.roast === 'light') roast = 'light';
      if (a.roast === 'dark') roast = 'dark';
      if (a.roast === 'any') roast = 'medium';

      const weakGrinder = ['pre-ground', 'blade'].includes(grinder);
      if (weakGrinder && roast === 'light') {
        roast = 'medium-dark';
        notes.push("Light roasts need consistent grind — with pre-ground or blade, they often taste sour. Going medium-dark for reliability.");
      }

      if (a.milk === 'always' && roast === 'light') {
        roast = 'medium-dark';
        notes.push("Milk tends to overwhelm the delicate notes in light roasts. Medium-dark gives body that plays better with milk.");
      }

      if (brew === 'pour-over' && roast === 'dark') {
        roast = 'medium';
        notes.push("Dark roasts can over-extract in filter and taste bitter. Medium keeps sweetness without harshness.");
      }

      if (brew === 'espresso') {
        const entryMachine = ['entry', 'not-sure'].includes(machine);
        if (entryMachine && roast === 'light') {
          roast = 'medium';
          notes.push("Light roasts are tricky on entry-level espresso machines — uneven extraction is common. Medium is more forgiving.");
        }
      }

      if (workflow === 'set-and-forget' && roast === 'light') {
        roast = 'medium';
        notes.push("Light roasts usually need more dialing in. Medium gives great results with less tweaking.");
      }

      if (a.milk === 'always') roast = roast === 'light' ? 'medium' : 'medium-dark';
      if (brew === 'espresso' || brew === 'stovetop') roast = roast === 'medium' ? 'medium-dark' : roast;

      const recs = {
        light: {
          title: 'Light Roast',
          line: `You’ll probably love ${style}.`,
          why: 'Light roasts highlight origin character and brightness — magic when your setup can extract them cleanly.'
        },
        medium: {
          title: 'Medium Roast',
          line: `You’ll probably like ${style}.`,
          why: 'The sweet spot: interesting, forgiving, works across most setups and with/without milk.'
        },
        'medium-dark': {
          title: 'Medium-Dark Roast',
          line: `You’ll probably enjoy richer, fuller-bodied coffee — ${style}.`,
          why: 'Great body and chocolate notes — reliable even with simpler grinders or milk drinks.'
        },
        dark: {
          title: 'Dark Roast',
          line: 'You’ll probably enjoy bold, classic coffee.',
          why: 'Heavy body, low acidity — very forgiving, especially for espresso + milk.'
        }
      };

      const pick = recs[roast] || recs.medium;

      const brewText = brew.replace('-', ' ');
      const milkText = a.milk === 'black' ? 'black' : (a.milk === 'always' ? 'with milk' : 'either');

      let html = `
        <div class="result-card">
          <p class="rec-title">Your match:</p>
          <h3>${pick.title}</h3>
          <p class="result-line">${pick.line}</p>

          <div class="why-box">
            <p class="why-title">Why this fits you</p>
            <p>${pick.why}</p>
            <p class="why-meta">
              Built for <strong>${brewText}</strong>, drinking it <strong>${milkText}</strong>,
              with a <strong>${grinder.replace('-', ' ')}</strong> grinder.
            </p>
          </div>
      `;

      if (notes.length > 0) {
        html += `
          <div class="why-box" style="background:rgba(255,52,0,0.08); border:1px solid rgba(255,52,0,0.2);">
            <p class="why-title" style="color:var(--brand);">A note from experience</p>
            <ul style="text-align:left; margin:10px 0; padding-left:20px;">
              ${notes.map(n => `<li>${n}</li>`).join('')}
            </ul>
          </div>
        `;
      }

      html += `
          <p class="small">Coming soon: direct links to Melbourne roasters that match this profile.</p>
        </div>
      `;

      recommendation.innerHTML = html;

      // Supabase insert (now should run + log)
      if (sb) {
        const payload = {
          session_id: sessionId,
          page: location.pathname,
          answers: a,
          derived: { roast, style, brew, grinder, machine }
        };

        sb.from("quiz_events").insert(payload)
          .then(({ data, error }) => {
            console.log("Supabase insert:", { data, error });
            if (error) console.warn("Supabase error:", error);
          })
          .catch(err => console.warn("Supabase failed:", err));
      } else {
        console.warn("Supabase client is null; skipping insert.");
      }

      results.classList.remove('hidden');
      form.classList.add('hidden');
      results.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    retakeBtn.addEventListener('click', () => {
      form.reset();
      results.classList.add('hidden');
      form.classList.remove('hidden');
      currentIndex = 0;
      rebuildActiveQuestions();
      showQuestion(currentIndex);
    });

    // Init
    rebuildActiveQuestions();
    showQuestion(0);
  </script>
</body>
</html>
